var clippy={Agent:function(path,data,sounds){this.path=path,this._queue=new clippy.Queue($.proxy(this._onQueueEmpty,this)),this._el=$('<div class="clippy"></div>').hide(),$(document.body).append(this._el),this._animator=new clippy.Animator(this._el,path,data,sounds),this._balloon=new clippy.Balloon(this._el),this._setupEvents()}};clippy.Agent.prototype={gestureAt:function(x,y){var d=this._getDirection(x,y),gAnim="Gesture"+d,lookAnim="Look"+d,animation=this.hasAnimation(gAnim)?gAnim:lookAnim;return this.play(animation)},hide:function(fast,callback){this._hidden=!0;var el=this._el;return this.stop(),fast?(this._el.hide(),this.stop(),this.pause(),void(callback&&callback())):this._playInternal("Hide",(function(){el.hide(),this.pause(),callback&&callback()}))},moveTo:function(x,y,duration){var dir,anim="Move"+this._getDirection(x,y);void 0===duration&&(duration=1e3),this._addToQueue((function(complete){if(0===duration)return this._el.css({top:y,left:x}),this.reposition(),void complete();if(this.hasAnimation(anim)){var callback=$.proxy((function(name,state){state===clippy.Animator.States.EXITED&&complete(),state===clippy.Animator.States.WAITING&&this._el.animate({top:y,left:x},duration,$.proxy((function(){this._animator.exitAnimation()}),this))}),this);this._playInternal(anim,callback)}else this._el.animate({top:y,left:x},duration,complete)}),this)},_playInternal:function(animation,callback){this._isIdleAnimation()&&this._idleDfd&&"pending"===this._idleDfd.state()&&this._idleDfd.done($.proxy((function(){this._playInternal(animation,callback)}),this)),this._animator.showAnimation(animation,callback)},play:function(animation,timeout,cb){return!!this.hasAnimation(animation)&&(void 0===timeout&&(timeout=5e3),this._addToQueue((function(complete){var completed=!1,callback=function(name,state){state===clippy.Animator.States.EXITED&&(completed=!0,cb&&cb(),complete())};timeout&&window.setTimeout($.proxy((function(){completed||this._animator.exitAnimation()}),this),timeout),this._playInternal(animation,callback)}),this),!0)},show:function(fast){if(this._hidden=!1,fast)return this._el.show(),this.resume(),void this._onQueueEmpty();if("auto"===this._el.css("top")||"auto"===!this._el.css("left")){var left=.8*$(window).width(),top=.8*($(window).height()+$(document).scrollTop());this._el.css({top:top,left:left})}return this.resume(),this.play("Show")},speak:function(text,hold){this._addToQueue((function(complete){this._balloon.speak(complete,text,hold)}),this)},closeBalloon:function(){this._balloon.hide()},delay:function(time){time=time||250,this._addToQueue((function(complete){this._onQueueEmpty(),window.setTimeout(complete,time)}))},stopCurrent:function(){this._animator.exitAnimation(),this._balloon.close()},stop:function(){this._queue.clear(),this._animator.exitAnimation(),this._balloon.hide()},hasAnimation:function(name){return this._animator.hasAnimation(name)},animations:function(){return this._animator.animations()},animate:function(){var animations=this.animations(),anim=animations[Math.floor(Math.random()*animations.length)];return 0===anim.indexOf("Idle")?this.animate():this.play(anim)},_getDirection:function(x,y){var offset=this._el.offset(),h=this._el.height(),w=this._el.width(),centerX=offset.left+w/2,centerY,a=offset.top+h/2-y,b=centerX-x,r=Math.round(180*Math.atan2(a,b)/Math.PI);return-45<=r&&r<45?"Right":45<=r&&r<135?"Up":135<=r&&r<=180||-180<=r&&r<-135?"Left":-135<=r&&r<-45?"Down":"Top"},_onQueueEmpty:function(){if(!this._hidden&&!this._isIdleAnimation()){var idleAnim=this._getIdleAnimation();this._idleDfd=$.Deferred(),this._animator.showAnimation(idleAnim,$.proxy(this._onIdleComplete,this))}},_onIdleComplete:function(name,state){state===clippy.Animator.States.EXITED&&this._idleDfd.resolve()},_isIdleAnimation:function(){var c=this._animator.currentAnimationName;return c&&0===c.indexOf("Idle")},_getIdleAnimation:function(){for(var animations=this.animations(),r=[],i=0;i<animations.length;i++){var a=animations[i];0===a.indexOf("Idle")&&r.push(a)}var idx;return r[Math.floor(Math.random()*r.length)]},_setupEvents:function(){$(window).on("resize",$.proxy(this.reposition,this)),this._el.on("mousedown",$.proxy(this._onMouseDown,this)),this._el.on("dblclick",$.proxy(this._onDoubleClick,this))},_onDoubleClick:function(){this.play("ClickedOn")||this.animate()},reposition:function(){if(this._el.is(":visible")){var o=this._el.offset(),bH=this._el.outerHeight(),bW=this._el.outerWidth(),wW=$(window).width(),wH=$(window).height(),sT=$(window).scrollTop(),sL=$(window).scrollLeft(),top=o.top-sT,left=o.left-sL,m=5;top-5<0?top=5:top+bH+5>wH&&(top=wH-bH-5),left-5<0?left=5:left+bW+5>wW&&(left=wW-bW-5),this._el.css({left:left,top:top}),this._balloon.reposition()}},_onMouseDown:function(e){e.preventDefault(),this._startDrag(e)},_startDrag:function(e){this.pause(),this._balloon.hide(!0),this._offset=this._calculateClickOffset(e),this._moveHandle=$.proxy(this._dragMove,this),this._upHandle=$.proxy(this._finishDrag,this),$(window).on("mousemove",this._moveHandle),$(window).on("mouseup",this._upHandle),this._dragUpdateLoop=window.setTimeout($.proxy(this._updateLocation,this),10)},_calculateClickOffset:function(e){var mouseX=e.pageX,mouseY=e.pageY,o=this._el.offset();return{top:mouseY-o.top,left:mouseX-o.left}},_updateLocation:function(){this._el.css({top:this._targetY,left:this._taregtX}),this._dragUpdateLoop=window.setTimeout($.proxy(this._updateLocation,this),10)},_dragMove:function(e){e.preventDefault();var x=e.clientX-this._offset.left,y=e.clientY-this._offset.top;this._taregtX=x,this._targetY=y},_finishDrag:function(){window.clearTimeout(this._dragUpdateLoop),$(window).off("mousemove",this._moveHandle),$(window).off("mouseup",this._upHandle),this._balloon.show(),this.reposition(),this.resume()},_addToQueue:function(func,scope){scope&&(func=$.proxy(func,scope)),this._queue.queue(func)},pause:function(){this._animator.pause(),this._balloon.pause()},resume:function(){this._animator.resume(),this._balloon.resume()}},clippy.Animator=function(el,path,data,sounds){this._el=el,this._data=data,this._path=path,this._currentFrameIndex=0,this._currentFrame=void 0,this._exiting=!1,this._currentAnimation=void 0,this._endCallback=void 0,this._started=!1,this._sounds={},this.currentAnimationName=void 0,this.preloadSounds(sounds),this._overlays=[this._el];var curr=this._el;this._setupElement(this._el);for(var i=1;i<this._data.overlayCount;i++){var inner=this._setupElement($("<div></div>"));curr.append(inner),this._overlays.push(inner),curr=inner}},clippy.Animator.prototype={_setupElement:function(el){var frameSize=this._data.framesize;return el.css("display","none"),el.css({width:frameSize[0],height:frameSize[1]}),el.css("background","url('"+this._path+"/map.png') no-repeat"),el},animations:function(){var r=[],d=this._data.animations;for(var n in d)r.push(n);return r},preloadSounds:function(sounds){for(var i=0;i<this._data.sounds.length;i++)var snd,uri=sounds[this._data.sounds[i]]},hasAnimation:function(name){return!!this._data.animations[name]},exitAnimation:function(){this._exiting=!0},showAnimation:function(animationName,stateChangeCallback){return this._exiting=!1,!!this.hasAnimation(animationName)&&(this._currentAnimation=this._data.animations[animationName],this.currentAnimationName=animationName,this._started||(this._step(),this._started=!0),this._currentFrameIndex=0,this._currentFrame=void 0,this._endCallback=stateChangeCallback,!0)},_draw:function(){var images=[];this._currentFrame&&(images=this._currentFrame.images||[]);for(var i=0;i<this._overlays.length;i++)if(i<images.length){var xy=images[i],bg=-xy[0]+"px "+-xy[1]+"px";this._overlays[i].css({"background-position":bg,display:"block"})}else this._overlays[i].css("display","none")},_getNextAnimationFrame:function(){if(this._currentAnimation){if(!this._currentFrame)return 0;var currentFrame=this._currentFrame,branching=this._currentFrame.branching;if(this._exiting&&void 0!==currentFrame.exitBranch)return currentFrame.exitBranch;if(branching)for(var rnd=100*Math.random(),i=0;i<branching.branches.length;i++){var branch=branching.branches[i];if(rnd<=branch.weight)return branch.frameIndex;rnd-=branch.weight}return this._currentFrameIndex+1}},_playSound:function(){var s=this._currentFrame.sound},_atLastFrame:function(){return this._currentFrameIndex>=this._currentAnimation.frames.length-1},_step:function(){if(this._currentAnimation){var newFrameIndex=Math.min(this._getNextAnimationFrame(),this._currentAnimation.frames.length-1),frameChanged=!this._currentFrame||this._currentFrameIndex!==newFrameIndex;this._currentFrameIndex=newFrameIndex,this._atLastFrame()&&this._currentAnimation.useExitBranching||(this._currentFrame=this._currentAnimation.frames[this._currentFrameIndex]),this._draw(),this._playSound(),this._loop=window.setTimeout($.proxy(this._step,this),this._currentFrame.duration),this._endCallback&&frameChanged&&this._atLastFrame()&&(this._currentAnimation.useExitBranching&&!this._exiting?this._endCallback(this.currentAnimationName,clippy.Animator.States.WAITING):this._endCallback(this.currentAnimationName,clippy.Animator.States.EXITED))}},pause:function(){window.clearTimeout(this._loop)},resume:function(){this._step()}},clippy.Animator.States={WAITING:1,EXITED:0},clippy.Balloon=function(targetEl){this._targetEl=targetEl,this._hidden=!0,this._setup()},clippy.Balloon.prototype={WORD_SPEAK_TIME:320,CLOSE_BALLOON_DELAY:2e3,_setup:function(){this._balloon=$('<div class="clippy-balloon"><div class="clippy-tip"></div><div class="clippy-content"></div></div> ').hide(),this._content=this._balloon.find(".clippy-content"),$(document.body).append(this._balloon)},reposition:function(){for(var sides=["top-left","top-right","bottom-left","bottom-right"],i=0;i<sides.length;i++){var s=sides[i];if(this._position(s),!this._isOut())break}},_BALLOON_MARGIN:15,_position:function(side){var o=this._targetEl.offset(),h=this._targetEl.height(),w=this._targetEl.width(),bH=this._balloon.outerHeight(),bW=this._balloon.outerWidth(),left,top;switch(this._balloon.removeClass("clippy-top-left"),this._balloon.removeClass("clippy-top-right"),this._balloon.removeClass("clippy-bottom-right"),this._balloon.removeClass("clippy-bottom-left"),side){case"top-left":left=o.left+w-bW,top=o.top-bH-this._BALLOON_MARGIN;break;case"top-right":left=o.left,top=o.top-bH-this._BALLOON_MARGIN;break;case"bottom-right":left=o.left,top=o.top+h+this._BALLOON_MARGIN;break;case"bottom-left":left=o.left+w-bW,top=o.top+h+this._BALLOON_MARGIN}this._balloon.css({top:top,left:left}),this._balloon.addClass("clippy-"+side)},_isOut:function(){var o=this._balloon.offset(),bH=this._balloon.outerHeight(),bW=this._balloon.outerWidth(),wW=$(window).width(),wH=$(window).height(),sT=$(document).scrollTop(),sL=$(document).scrollLeft(),top=o.top-sT,left=o.left-sL,m=5;return top-5<0||left-5<0||(top+bH+5>wH||left+bW+5>wW)},speak:function(complete,text,hold){this._hidden=!1,this.show();var c=this._content;c.height("auto"),c.width("auto"),c.text(text),c.height(c.height()),c.width(c.width()),c.text(""),this.reposition(),this._complete=complete,this._sayWords(text,hold,complete)},show:function(){this._hidden||this._balloon.show()},hide:function(fast){fast?this._balloon.hide():this._hiding=window.setTimeout($.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY)},_finishHideBalloon:function(){this._active||(this._balloon.hide(),this._hidden=!0,this._hiding=null)},_sayWords:function(text,hold,complete){this._active=!0,this._hold=hold;var words=text.split(/[^\S-]/),time=this.WORD_SPEAK_TIME,el=this._content,idx=1;this._addWord=$.proxy((function(){this._active&&(idx>words.length?(this._active=!1,this._hold||(complete(),this.hide())):(el.text(words.slice(0,idx).join(" ")),idx++,this._loop=window.setTimeout($.proxy(this._addWord,this),time)))}),this),this._addWord()},close:function(){this._active?this._hold=!1:this._hold&&this._complete()},pause:function(){window.clearTimeout(this._loop),this._hiding&&(window.clearTimeout(this._hiding),this._hiding=null)},resume:function(){this._addWord&&this._addWord(),this._hiding=window.setTimeout($.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY)}},clippy.BASE_PATH="//s3.amazonaws.com/clippy.js/Agents/",clippy.load=function(name,successCb,failCb){var path=clippy.BASE_PATH+name,mapDfd=clippy.load._loadMap(path),agentDfd=clippy.load._loadAgent(name,path),soundsDfd=clippy.load._loadSounds(name,path),data,sounds;agentDfd.done((function(d){data=d})),soundsDfd.done((function(d){sounds=d}));var cb=function(){var a=new clippy.Agent(path,data,sounds);successCb(a)};$.when(mapDfd,agentDfd,soundsDfd).done(cb).fail(failCb)},clippy.load._maps={},clippy.load._loadMap=function(path){var dfd=clippy.load._maps[path];if(dfd)return dfd;dfd=clippy.load._maps[path]=$.Deferred();var src=path+"/map.png",img=new Image;return img.onload=dfd.resolve,img.onerror=dfd.reject,img.setAttribute("src",src),dfd.promise()},clippy.load._sounds={},clippy.load._loadSounds=function(name,path){var dfd=clippy.load._sounds[name];if(dfd)return dfd;dfd=clippy.load._sounds[name]=$.Deferred();var audio=document.createElement("audio"),canPlayMp3=!!audio.canPlayType&&""!=audio.canPlayType("audio/mpeg"),canPlayOgg=!!audio.canPlayType&&""!=audio.canPlayType('audio/ogg; codecs="vorbis"');if(canPlayMp3||canPlayOgg){var src=path+(canPlayMp3?"/sounds-mp3.js":"/sounds-ogg.js");clippy.load._loadScript(src)}else dfd.resolve({});return dfd.promise()},clippy.load._data={},clippy.load._loadAgent=function(name,path){var dfd=clippy.load._data[name];if(dfd)return dfd;dfd=clippy.load._getAgentDfd(name);var src=path+"/agent.js";return clippy.load._loadScript(src),dfd.promise()},clippy.load._loadScript=function(src){var script=document.createElement("script");script.setAttribute("src",src),script.setAttribute("async","async"),script.setAttribute("type","text/javascript"),document.head.appendChild(script)},clippy.load._getAgentDfd=function(name){var dfd=clippy.load._data[name];return dfd||(dfd=clippy.load._data[name]=$.Deferred()),dfd},clippy.ready=function(name,data){var dfd;clippy.load._getAgentDfd(name).resolve(data)},clippy.soundsReady=function(name,data){var dfd=clippy.load._sounds[name];dfd||(dfd=clippy.load._sounds[name]=$.Deferred()),dfd.resolve(data)},clippy.Queue=function(onEmptyCallback){this._queue=[],this._onEmptyCallback=onEmptyCallback},clippy.Queue.prototype={queue:function(func){this._queue.push(func),1!==this._queue.length||this._active||this._progressQueue()},_progressQueue:function(){if(this._queue.length){var f=this._queue.shift(),completeFunction;this._active=!0,f($.proxy(this.next,this))}else this._onEmptyCallback()},clear:function(){this._queue=[]},next:function(){this._active=!1,this._progressQueue()}};